;==================================================================================================
; TRACE32 Script: HardFaultè¯Šæ–­è„šæœ¬
;==================================================================================================
AREA.Create DIAG
AREA.Select DIAG
AREA.Clear
PRINT "========================================================================"
PRINT "HardFault æ·±åº¦è¯Šæ–­ - INVSTATEé”™è¯¯"
PRINT "========================================================================"
PRINT ""
;====================================================================================
; 1. æ£€æŸ¥æ ˆé…ç½®
;====================================================================================
PRINT "ã€1ã€‘æ ˆé…ç½®æ£€æŸ¥:"
PRINT "------------------------------------------------------------------------"
LOCAL &stack_start &stack_end &stack_size
&stack_start=ADDRESS.OFFSET(__Stack_dtcm_start)
&stack_end=ADDRESS.OFFSET(__Stack_dtcm_end)
&stack_size=&stack_start-&stack_end
PRINT "  ä¸»æ ˆ(MSP)é…ç½®:"
PRINT "    Stack Start  : 0x" FORMAT.HEX(8,&stack_start) " (linkeråˆ†é…)"
PRINT "    Stack End    : 0x" FORMAT.HEX(8,&stack_end) " (linkeråˆ†é…)"
PRINT "    Stack Size   : " %DECIMAL &stack_size " å­—èŠ‚ (" %DECIMAL (&stack_size/1024) " KB)"
LOCAL &current_sp &msp &psp
&current_sp=REGISTER(SP)
&msp=REGISTER(MSP)
&psp=REGISTER(PSP)
PRINT ""
PRINT "  å½“å‰æ ˆæŒ‡é’ˆ:"
PRINT "    SP (å½“å‰)    : 0x" FORMAT.HEX(8,&current_sp)
PRINT "    MSP (ä¸»æ ˆ)   : 0x" FORMAT.HEX(8,&msp)
PRINT "    PSP (è¿›ç¨‹æ ˆ) : 0x" FORMAT.HEX(8,&psp)
LOCAL &stack_used &stack_free
&stack_used=&stack_start-&msp
&stack_free=&msp-&stack_end
PRINT ""
PRINT "  æ ˆä½¿ç”¨æƒ…å†µ:"
PRINT "    å·²ä½¿ç”¨: " %DECIMAL &stack_used " å­—èŠ‚"  
PRINT "    å¯ç”¨:   " %DECIMAL &stack_free " å­—èŠ‚"
PRINT "    ä½¿ç”¨ç‡: " %DECIMAL ((&stack_used*100)/&stack_size) "%"
IF &stack_free<400
(
  PRINT ""
  PRINT "  âš ï¸ è­¦å‘Š: ä¸»æ ˆç©ºé—´ä¸è¶³400å­—èŠ‚ï¼"
  PRINT "  âš ï¸ è¿™å¯èƒ½å¯¼è‡´æ ˆæº¢å‡ºï¼"
)
PRINT ""
;====================================================================================
; 2. æ£€æŸ¥å…³é”®å¯„å­˜å™¨
;====================================================================================
PRINT "ã€2ã€‘å…³é”®å¯„å­˜å™¨çŠ¶æ€:"
PRINT "------------------------------------------------------------------------"
LOCAL &pc &lr &r0 &r1 &r2 &r3
&pc=REGISTER(PC)
&lr=REGISTER(LR)
&r0=REGISTER(R0)
&r1=REGISTER(R1)
&r2=REGISTER(R2)
&r3=REGISTER(R3)
PRINT "  PC  = 0x" FORMAT.HEX(8,&pc)
PRINT "  LR  = 0x" FORMAT.HEX(8,&lr)
PRINT "  R0  = 0x" FORMAT.HEX(8,&r0)
PRINT "  R1  = 0x" FORMAT.HEX(8,&r1)
PRINT "  R2  = 0x" FORMAT.HEX(8,&r2)
PRINT "  R3  = 0x" FORMAT.HEX(8,&r3)
; æ£€æŸ¥ LR æ˜¯å¦ä¸ºæœ‰æ•ˆå¼‚å¸¸è¿”å›å€¼
IF (&lr==0xFFFFFFF1)||(&lr==0xFFFFFFF9)||(&lr==0xFFFFFFD)||(&lr==0xFFFFFFED)||(&lr==0xFFFFFFFD)
(
  PRINT ""
  PRINT "  âœ“ LRå€¼æ­£å¸¸ (æœ‰æ•ˆçš„å¼‚å¸¸è¿”å›å€¼)"
)
ELSE
(
  PRINT ""
  PRINT "  âŒ LRå€¼å¼‚å¸¸ï¼ä¸æ˜¯æœ‰æ•ˆçš„å¼‚å¸¸è¿”å›å€¼"
  PRINT "     æ­£å¸¸å€¼åº”è¯¥æ˜¯: 0xFFFFFFF1/F9/FD/ED"
  PRINT "     è¿™é€šå¸¸è¡¨ç¤ºæ ˆè¢«ç ´åï¼"
)
PRINT ""
;====================================================================================
; 3. æ£€æŸ¥FaultçŠ¶æ€å¯„å­˜å™¨
;====================================================================================
PRINT "ã€3ã€‘FaultçŠ¶æ€å¯„å­˜å™¨:"
PRINT "------------------------------------------------------------------------"
LOCAL &hfsr &cfsr &mmfar &bfar
&hfsr=Data.Long(EAHB:0xE000ED2C)
&cfsr=Data.Long(EAHB:0xE000ED28)
&mmfar=Data.Long(EAHB:0xE000ED34)
&bfar=Data.Long(EAHB:0xE000ED38)
PRINT "  HFSR  @ 0xE000ED2C = 0x" FORMAT.HEX(8,&hfsr)
PRINT "  CFSR  @ 0xE000ED28 = 0x" FORMAT.HEX(8,&cfsr)
PRINT "  MMFAR @ 0xE000ED34 = 0x" FORMAT.HEX(8,&mmfar)
PRINT "  BFAR  @ 0xE000ED38 = 0x" FORMAT.HEX(8,&bfar)
PRINT ""
PRINT "  CFSRä½å­—æ®µè§£æ:"
; UFSR (bits 16-31)
LOCAL &ufsr
&ufsr=(&cfsr>>16)&0xFFFF
IF (&ufsr&0x0001)!=0
  PRINT "    [Bit 16] UNDEFINSTR  = 1 (æœªå®šä¹‰æŒ‡ä»¤)"
IF (&ufsr&0x0002)!=0
  PRINT "    [Bit 17] INVSTATE    = 1 (âŒ éæ³•çŠ¶æ€ - Thumb/ARMæ··ä¹±)"
IF (&ufsr&0x0004)!=0
  PRINT "    [Bit 18] INVPC       = 1 (éæ³•PCåŠ è½½)"
IF (&ufsr&0x0008)!=0
  PRINT "    [Bit 19] NOCP        = 1 (æ— åå¤„ç†å™¨)"
IF (&ufsr&0x0100)!=0
  PRINT "    [Bit 24] UNALIGNED   = 1 (æœªå¯¹é½è®¿é—®)"
IF (&ufsr&0x0200)!=0
  PRINT "    [Bit 25] DIVBYZERO   = 1 (é™¤é›¶)"
PRINT ""
;====================================================================================
; 4. æ£€æŸ¥å‘é‡è¡¨é…ç½®
;====================================================================================
PRINT "ã€4ã€‘å‘é‡è¡¨æ£€æŸ¥:"
PRINT "------------------------------------------------------------------------"
LOCAL &vtor &reset_vec &hardfault_vec
&vtor=Data.Long(EAHB:0xE000ED08)
&reset_vec=Data.Long(EAHB:&vtor+4)
&hardfault_vec=Data.Long(EAHB:&vtor+12)
PRINT "  VTOR           = 0x" FORMAT.HEX(8,&vtor)
PRINT "  Reset Vector   = 0x" FORMAT.HEX(8,&reset_vec)
PRINT "  HardFault Vec  = 0x" FORMAT.HEX(8,&hardfault_vec)
; æ£€æŸ¥å‘é‡è¡¨åœ°å€æ˜¯å¦å¯¹é½
IF (&vtor&0x7F)!=0
(
  PRINT ""
  PRINT "  âŒ è­¦å‘Š: VTORæœªæŒ‰128å­—èŠ‚å¯¹é½ï¼"
)
; æ£€æŸ¥Resetå‘é‡çš„Thumbä½
IF (&reset_vec&0x1)==0
(
  PRINT ""
  PRINT "  âŒ è­¦å‘Š: Reset_Handlerçš„Thumbä½æœªè®¾ç½®ï¼"
  PRINT "     è¿™ä¼šå¯¼è‡´INVSTATEé”™è¯¯"
)
PRINT ""
;====================================================================================
; 5. æ£€æŸ¥main()å’Œå…³é”®å‡½æ•°åœ°å€
;====================================================================================
PRINT "ã€5ã€‘å…³é”®å‡½æ•°åœ°å€æ£€æŸ¥:"
PRINT "------------------------------------------------------------------------"
LOCAL &main_addr &preos_addr &startos_addr
&main_addr=ADDRESS.OFFSET(main)
&preos_addr=ADDRESS.OFFSET(EcuM_PreOS_Init)
&startos_addr=ADDRESS.OFFSET(EcuM_StartOS)
PRINT "  main()           @ 0x" FORMAT.HEX(8,&main_addr) " (Thumb=" FORMAT.HEX(1,&main_addr&1) ")"
PRINT "  EcuM_PreOS_Init  @ 0x" FORMAT.HEX(8,&preos_addr) " (Thumb=" FORMAT.HEX(1,&preos_addr&1) ")"
PRINT "  EcuM_StartOS     @ 0x" FORMAT.HEX(8,&startos_addr) " (Thumb=" FORMAT.HEX(1,&startos_addr&1) ")"
PRINT ""
;====================================================================================
; 6. åæ±‡ç¼–å½“å‰PCä½ç½®
;====================================================================================
PRINT "ã€6ã€‘å½“å‰PCä½ç½®åæ±‡ç¼–:"
PRINT "------------------------------------------------------------------------"
Data.List &pc--20
PRINT ""
;====================================================================================
; 7. æ ˆå†…å®¹æ£€æŸ¥
;====================================================================================
PRINT "ã€7ã€‘æ ˆé¡¶å†…å®¹åˆ†æ (æœ€åå‹æ ˆçš„æ•°æ®):"
PRINT "------------------------------------------------------------------------"
LOCAL &i &addr &value
REPEAT 8
(
  &addr=&msp+(&i*4)
  &value=Data.Long(EAHB:&addr)
  PRINT "  MSP+" FORMAT.HEX(2,&i*4) " [0x" FORMAT.HEX(8,&addr) "] = 0x" FORMAT.HEX(8,&value)
  &i=&i+1
)
PRINT ""
;====================================================================================
; æ€»ç»“å’Œå»ºè®®
;====================================================================================
PRINT "========================================================================"
PRINT "è¯Šæ–­å»ºè®®:"
PRINT "========================================================================"
IF (&lr!=0xFFFFFFF1)&&(&lr!=0xFFFFFFF9)&&(&lr!=0xFFFFFFFD)
(
  PRINT ""
  PRINT "ğŸ”´ ä¸¥é‡: LRå¯„å­˜å™¨æŸåï¼"
  PRINT "   å¯èƒ½åŸå› :"
  PRINT "   1. ä¸»æ ˆæº¢å‡º,è¦†ç›–äº†æ ˆå¸§"
  PRINT "   2. FreeRTOSå †é…ç½®è¿‡å¤§,ä¾µå äº†æ ˆç©ºé—´"
  PRINT "   å»ºè®®:"
  PRINT "   - å¢åŠ ä¸»æ ˆå¤§å°(å½“å‰ " %DECIMAL (&stack_size/1024) "KB)"
  PRINT "   - å‡å°‘FreeRTOSå †å¤§å°(æ£€æŸ¥FreeRTOSConfig.h)"
  PRINT "   - æ£€æŸ¥æ˜¯å¦æœ‰å‡½æ•°é€’å½’è°ƒç”¨"
)
IF (&ufsr&0x0002)!=0
(
  PRINT ""
  PRINT "ğŸ”´ INVSTATEé”™è¯¯!"
  PRINT "   å¯èƒ½åŸå› :"
  PRINT "   1. è·³è½¬åˆ°éThumbä»£ç (LSB=0çš„åœ°å€)"
  PRINT "   2. LRå¯„å­˜å™¨è¢«ç ´å"
  PRINT "   3. å‘é‡è¡¨å¼‚å¸¸å‘é‡LSB=0"
  PRINT "   å»ºè®®:"
  PRINT "   - æ£€æŸ¥Vector_Table.sä¸­çš„å‡½æ•°åœ°å€æ˜¯å¦åŠ 1"
  PRINT "   - ç¡®è®¤æ‰€æœ‰.cæ–‡ä»¶ç¼–è¯‘ä¸ºThumbæ¨¡å¼"
)
IF &stack_free<1024
(
  PRINT ""
  PRINT "ğŸŸ¡ è­¦å‘Š: ä¸»æ ˆç©ºé—´ç´§å¼ (å‰©ä½™ " %DECIMAL &stack_free " å­—èŠ‚)"
  PRINT "   å»ºè®®: å¢åŠ ä¸»æ ˆå¤§å°"
)
PRINT ""
PRINT "========================================================================"
PRINT "è¯Šæ–­å®Œæˆ"
PRINT "========================================================================"
ENDDO
